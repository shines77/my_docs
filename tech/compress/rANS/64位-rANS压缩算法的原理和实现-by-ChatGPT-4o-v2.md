# 64ä½ rANS å‹ç¼©ç®—æ³•çš„åŸç†å’Œå®ç°

## é—®é¢˜

è¯·ä»‹ç»ä¸€ä¸‹å‹ç¼©ç®—æ³•ä¸­çš„ rANS èŒƒå›´ç¼–ç çš„å‹ç¼©ã€è§£å‹åŸç†å’Œå…·ä½“å®ç°ï¼Œä½¿ç”¨ 64 ä½æ•´å‹ç‰ˆæœ¬ï¼Œä½¿ç”¨ C++ ä»£ç ç¤ºä¾‹ï¼Œå¹¶æ·»åŠ ä¸­æ–‡æ³¨é‡Šã€‚

## å›ç­”

ï¼ˆæ¥è‡ª ChatGPT-4oï¼Œ[https://home.chatplus.cc/](https://home.chatplus.cc/)ï¼‰

æ‚¨æŒ‡å‡ºçš„é—®é¢˜éå¸¸å‡†ç¡®ï¼Œæˆ‘ä¹‹å‰æä¾›çš„ç¤ºä¾‹ä»£ç ç¡®å®å­˜åœ¨é—®é¢˜ã€‚åœ¨ rANSï¼ˆèŒƒå›´éå¯¹ç§°æ•°ç³»ç»Ÿï¼‰ç¼–ç ä¸­ï¼Œ`range` å˜é‡åº”åœ¨çŠ¶æ€æ›´æ–°ä¸­å‘æŒ¥å…³é”®ä½œç”¨ï¼Œä½†åœ¨æˆ‘ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œå®ƒæœªè¢«æ­£ç¡®ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œç¼–ç å’Œè§£ç å‡½æ•°çš„å®ç°ä¹Ÿæœªéµå¾ª rANS çš„æ ‡å‡†å…¬å¼ã€‚ä¸ºäº†æ›´æ¸…æ™°åœ°è¯´æ˜ rANS çš„å·¥ä½œåŸç†ï¼Œæˆ‘å°†æä¾›ä¸€ä¸ªç®€åŒ–çš„ 64 ä½ rANS ç¼–ç å’Œè§£ç çš„ C++ ç¤ºä¾‹ï¼Œå¹¶é™„ä¸Šä¸­æ–‡æ³¨é‡Šã€‚

### ğŸ” rANS ç®—æ³•åŸç†

rANS æ˜¯ä¸€ç§ç†µç¼–ç ç®—æ³•ï¼Œå®ƒé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæ•´æ•°çŠ¶æ€ `x` æ¥è¡¨ç¤ºç¼–ç è¿‡ç¨‹ä¸­çš„ä¿¡æ¯îˆƒç¼–ç å’Œè§£ç è¿‡ç¨‹é€šè¿‡å¯¹ `x` çš„æ›´æ–°æ¥å®ç°ç¬¦å·çš„å‹ç¼©å’Œè¿˜åŸîˆƒå…³é”®çš„ç¼–ç å’Œè§£ç å…¬å¼å¦‚ä¸‹îˆ„îˆ†

- **ç¼–ç å…¬å¼**ï¼š

$$
x_{\text{new}} = \left\lfloor \frac{x}{f_s} \right\rfloor \cdot R + (x \mod f_s) + \text{CDF}[s]
$îˆ„îˆ†

- **è§£ç å…¬å¼**ï¼š

$$
s = \text{symbol}(x \mod R) \\
x_{\text{old}} = f_s \cdot \left\lfloor \frac{x}{R} \right\rfloor + (x \mod R) - \text{CDF}[s]
$îˆ„îˆ†

å…¶ä¸­ï¼š

- $x$ æ˜¯å½“å‰çš„çŠ¶æ€
- $f_s$ æ˜¯ç¬¦å· $s$ çš„é¢‘ç‡
- $R$ æ˜¯é¢‘ç‡æ€»å’Œï¼Œé€šå¸¸ä¸º $2^n$
- $\text{CDF}[s]$ æ˜¯ç¬¦å· $s$ çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°å€¼
- $\text{symbol}(y)$ æ˜¯æ ¹æ® $y$ å€¼æŸ¥æ‰¾å¯¹åº”ç¬¦å·çš„å‡½æ•°

### ğŸ§ª C++ 64 ä½ rANS å®ç°ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ 64 ä½ rANS ç¼–ç å’Œè§£ç çš„ C++ å®ç°ç¤ºä¾‹ï¼Œä½¿ç”¨å›ºå®šçš„é¢‘ç‡è¡¨å’Œç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆCDFï¼‰ï¼š

```cpp
#include <iostream>
#include <vector>
#include <cstdint>
#include <cassert>

// å®šä¹‰é¢‘ç‡è¡¨å’Œç´¯ç§¯åˆ†å¸ƒå‡½æ•°
const uint32_t R = 1 << 12; // æ€»é¢‘ç‡ï¼Œé€šå¸¸ä¸º 2 çš„å¹‚
const uint32_t freq_table[3] = {512, 256, 128}; // ç¤ºä¾‹é¢‘ç‡ï¼šç¬¦å· A, B, C
const uint32_t cdf_table[3] = {0, 512, 768};    // ç´¯ç§¯åˆ†å¸ƒå‡½æ•°

// æŸ¥æ‰¾ç¬¦å·å‡½æ•°ï¼Œæ ¹æ® y å€¼è¿”å›å¯¹åº”çš„ç¬¦å·ç´¢å¼•
uint32_t symbol_lookup(uint32_t y) {
    for (uint32_t i = 0; i < 3; ++i) {
        if (y < cdf_table[i] + freq_table[i]) {
            return i;
        }
    }
    // å¦‚æœæœªæ‰¾åˆ°ï¼Œè¿”å›æ— æ•ˆå€¼
    return -1;
}

// ç¼–ç å‡½æ•°
void rans_encode(const std::vector<uint32_t>& input, std::vector<uint64_t>& output) {
    uint64_t x = R; // åˆå§‹çŠ¶æ€ï¼Œå¿…é¡»å¤§äºç­‰äº R
    for (auto it = input.rbegin(); it != input.rend(); ++it) {
        uint32_t s = *it;
        uint32_t f = freq_table[s];
        uint32_t c = cdf_table[s];
        // æ›´æ–°çŠ¶æ€
        x = (x / f) * R + (x % f) + c;
    }
    output.push_back(x); // å°†æœ€ç»ˆçŠ¶æ€ä½œä¸ºç¼–ç ç»“æœ
}

// è§£ç å‡½æ•°
void rans_decode(uint64_t x, size_t output_size, std::vector<uint32_t>& output) {
    for (size_t i = 0; i < output_size; ++i) {
        uint32_t y = x % R;
        uint32_t s = symbol_lookup(y);
        assert(s != -1); // ç¡®ä¿æ‰¾åˆ°æœ‰æ•ˆç¬¦å·
        output.push_back(s);
        uint32_t f = freq_table[s];
        uint32_t c = cdf_table[s];
        // æ›´æ–°çŠ¶æ€
        x = f * (x / R) + y - c;
    }
    // ç”±äºç¼–ç æ˜¯ä»åå‘å‰çš„ï¼Œè§£ç åéœ€è¦åè½¬è¾“å‡º
    std::reverse(output.begin(), output.end());
}

int main() {
    // è¾“å…¥ç¬¦å·åºåˆ—ï¼šA=0, B=1, C=2
    std::vector<uint32_t> input = {0, 1, 2, 0, 1, 0};
    std::vector<uint64_t> encoded;
    std::vector<uint32_t> decoded;

    // ç¼–ç 
    rans_encode(input, encoded);

    // è§£ç 
    rans_decode(encoded[0], input.size(), decoded);

    // è¾“å‡ºè§£ç ç»“æœ
    for (auto s : decoded) {
        std::cout << "Decoded symbol: " << s << std::endl;
    }

    return 0;
}
```

**è¯´æ˜**ï¼š

- æ­¤ç¤ºä¾‹ä¸­ï¼Œ`freq_table` å’Œ `cdf_table` å®šä¹‰äº†ç¬¦å· Aã€Bã€C çš„é¢‘ç‡å’Œç´¯ç§¯åˆ†å¸ƒå‡½ã€‚
- `rans_encode` å‡½æ•°ä»è¾“å…¥åºåˆ—çš„æœ«å°¾å¼€å§‹ç¼–ç ï¼Œæ›´æ–°çŠ¶æ€ `xã€‚
- `rans_decode` å‡½æ•°æ ¹æ®çŠ¶æ€ `x` è§£ç ç¬¦å·ï¼Œå¹¶æ›´æ–°çŠ¶ã€‚
- ç”±äºç¼–ç æ˜¯ä»åå‘å‰è¿›è¡Œçš„ï¼Œè§£ç åéœ€è¦åè½¬è¾“å‡ºåºåˆ—ä»¥è·å¾—æ­£ç¡®çš„é¡ºã€‚îˆ†

### âš™ï¸ 64 ä½å®ç°çš„ä¼˜åŠ¿

åœ¨ 64 ä½æ¶æ„ä¸Šï¼Œä½¿ç”¨ 64 ä½æ•´æ•°è¿›è¡Œ rANS ç¼–ç å’Œè§£ç å…·æœ‰ä»¥ä¸‹ä¼˜ï¼šîˆ„îˆ†

- **æ›´å¤§çš„æ•°å€¼èŒƒå›´*ï¼šîˆƒ64 ä½æ•´æ•°æä¾›æ›´å¤§çš„æ•°å€¼èŒƒå›´ï¼Œå‡å°‘äº†æº¢å‡ºçš„é£ã€‚
- **æ›´é«˜çš„ç²¾åº¦*ï¼šîˆƒèƒ½å¤Ÿæ›´ç²¾ç¡®åœ°è¡¨ç¤ºæ¦‚ç‡åˆ†å¸ƒï¼Œæå‡å‹ç¼©æ•ˆã€‚
- **æ›´å¿«çš„å¤„ç†é€Ÿåº¦*ï¼šîˆƒç°ä»£ 64 ä½å¤„ç†å™¨å¯¹ 64 ä½æ•´æ•°çš„å¤„ç†é€Ÿåº¦æ›´ã€‚
îˆ†
å› æ­¤ï¼Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œ64 ä½ rANS å®ç°èƒ½å¤Ÿæä¾›æ›´ä¼˜çš„æ€§èƒ½å’Œå‹ç¼©æ•ˆã€‚

### ğŸ“š å‚è€ƒèµ„æ–™

- [rANS Notes by fgiesen](https://fgiesen.wordpress.com/2014/02/02/rans-note/)

- [rygorous/ryg_rans GitHub Repository](https://github.com/rygorous/ryg_ras)

- [Asymmetric numeral systems - Wikipedia](https://en.wikipedia.org/wiki/Asymmetric_numeral_systes)

å¦‚æœæ‚¨éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œä¾‹å¦‚å®ç°è‡ªé€‚åº”æ¨¡å‹ã€å¤„ç†ä¸åŒç¬¦å·é›†æˆ–ä¼˜åŒ–æ€§èƒ½ï¼Œè¯·éšæ—¶æå‡ºã€‚
