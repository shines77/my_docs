# AC 自动机

## 1. AC 自动机

> 是由 `贝尔实验室` 的两位研究人员 `Alfred V. Aho` 和 `Margaret J.Corasick` 于 `1975` 年发明的。

`AC 自动机`（Aho–Corasick Automation）是一种字符串匹配算法，可以同时将目标串与所有模式串进行匹配，算法均摊情况下具有近似于线性的时间复杂度。`AC 自动机` 的匹配原理有两个核心概念：`Trie` 字典树、`Fail 指针` 。

`AC 自动机` 是使用 `前缀树` 来存放所有 `模式串` 的 `前缀`，然后通过 `失配指针` 来处理失配的情况。它大概分为三个步骤：构建前缀树（将模式串集合逐一字符添加到 `Ac Trie` 中，生成 goto 表），生成失配指针（生成 fail 指针），模式匹配（构造 output 表）。

`AC 自动机` 包括 `goto 表`、`output 表` 和 `fail 表`。

### 1.1 goto 表

`goto表` 其实就是一棵 `前缀树`，用来将每个模式串索引到 `前缀树` 上。

我们假设，模式串 (`pattern`) 集合为 { `he`, `she`, `his`, `hers` } 。

把模式串集合往 `Ac Trie` 上填，得到下图：

![goto 表](./images/ac-auto-goto-table.jpeg)

`goto表` 与 `字典树` 的区别是，`goto表` 的根节点不光可以按 `h` 和 `s` 转移，还接受任意其他字符，转移目标都是根节点 (`root`) 自己。这样就形成了一个圈，使得一棵树变为一幅 `有向有环图` 。

> ### 有向有环图：“图论” 相关知识，有回路的有向图。

### 1.2 output 表

给定一个状态(节点)，我们需要知道该状态是否对应某个或某些模式串，以决定是否输出模式串(是否存在于词典中)以及对应的值，这时我们用到的关联结构就是 `output表` 。

在上面的案例中，`output表` 就是上图中的所有深蓝色的节点，对应的 `output表` 如下：

{ 2 → he，5 → he、she，7 → his，9 → hers }

如下图所示：

![output 表](./images/ac-auto-output-table.jpeg)

### 1.3 fail 表

`fail表` 保存的状态是转移失败后，应当回退到的最佳状态。最佳状态指的是已匹配过的字符串里，从最后匹配的位置开始算起，存在于 `goto表` 中的最长后缀的那个状态。

例如："`shi`" 匹配到 `状态 4`，发现 '`i`' 与 '`e`' 不匹配，此时，已经匹配成功的 "`sh`" 字符串里，从 '`h`' 往前推，能匹配的只有 '`h`' 字符，即 `fail` 指针指向 `状态 1`，转移到 `状态 1` 然后继续判断 '`i`' 是否能匹配。

加上完整的 `fail 表` 后，自动机 `Ac Trie` 如下图所示：

![加入 fail 表的 AC 自动机](./images/ac-auto-fail-table.jpeg)

#### 1.3.1 fail 表的构建流程

定义 `S` 为当前状态；`S.goto(C)` 为转移表，返回 `S` 按字符 `c` 转移的状态，`null` 表示转移失败；`S.fail` 为 `fail表`，代表转移失败时候从状态 `S` 回退的状态。

1. 初始状态的 `goto表` 是满的，永远不会失败，因此没有 `fail指针`。与初始状态直接相连的所有状态，其 `fail指针` 都指向初始状态。

2. 从初始状态开始进行广度优先遍历 `(BFS)`，若当前状态 `S` 接受字符 `c` 直达的状态为 `T`，则沿着 `S` 的 `fail指针` 回溯，直到找到第一个前驱状态 `F`，使得 `F.goto(c) != null` 。将 `T` 的 `fail指针` 设为 `F.goto(c)` 。简单来说，就是寻找状态 `S` 的存在于 `goto表` 中的最长后缀的状态 `F`。

3. (更新 `output表`) 由于 `F` 路径是 `T` 路径的后缀，因而 `T` 的 `output` 也应包含 `F` 的 `output`，因此将 `F` 的 `output` 添加到 `T` 的 `output` 中。

## 2. 参考文章

* [ac自动机 匹配最长前缀_学习NLP的第5天——AC自动机](https://blog.csdn.net/weixin_29359001/article/details/112266386) from [blog.csdn.net]

* [AC自动机](https://zhuanlan.zhihu.com/p/80325757) by [`知乎`] 司徒正美
